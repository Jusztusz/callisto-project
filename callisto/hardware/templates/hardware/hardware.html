<!DOCTYPE html>
{% load static tailwind_tags %}
<html lang="en" class="bg-[#0d0d0d]">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="{% static 'js/test.js' %}"></script>
    <title>Document</title>
    <style>
        #cpuProgressBarPercent {
            width: 250px;
            height: 150px;
        }

        #memoryProgressBarPercent {
            width: 250px;
            height: 150px;
            display: none;
        }

        #memoryProgressBarMB {
            width: 250px;
            height: 150px;
        }

        .progressbar-text {
            font-size: 24px;
            text-align: center;
        }

        #diskProgressBars {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>

<body>
    <section class="w-full text-black flex min-h-[100vh]">
        <div>
            {% include 'nav.html' %}
        </div>
        <div class="bg-[#ffffff] w-[90%] h-min-[800px] mt-6 mr-6 ml-52 border-l-[#eaecee] border-2 rounded-t-3xl">
            <div class="w-full h-20 border-b-[#edeef1] border-b-2">
                <h1 class="pt-3 pl-10 text-lg font-semibold">Hardver felügyelet</h1>
                <i class="pt-3 pl-10 ">Péntek, 2024.10.01</i>
            </div>
            <div class="w-full mt-6 ml-6 flex flex-wrap">
                <div class="w-[450px] pt-4 pb-4 pl-4 rounded-3xl text-lg bg-[#ffffff] border-[#e2e4e6] shadow1">
                    <p class="font-semibold">Processzor:</p> <span id="cpu_type"></span>
                    <p class="font-semibold">Magok száma:</p> <span id="core_count"></span>
                    <p class="font-semibold">Összes memória:</p> <span id="ram_all"></span>
                </div>
            </div>
            <!-- Dashboard -->
            <div class="w-full min-h-[300px] flex ml-6 mt-6">
                <div class="w-[95%] min-h-[300px] bg-[#ffffff] text-black flex flex-wrap justify-center shadow1 rounded-3xl">
                    <div class="w-full h-8 flex justify-between mt-3 text-xl font-semibold">
                        <div class="w-[56px]"></div>
                        <div>
                            <h2>Elsődleges nézet</h2>
                        </div>
                        <div>
                            <button id="open-btn"><img src="{% static 'img/edit.png' %}" alt=""
                                    class="h-7 ml-4 mr-4 pt-1"></button>
                            {% include 'primary_editor.html' %}
                        </div>
                    </div>
                    <div class="flex justify-center text-center">
                        <div class="flex justify-center text-center">
                            <div id="memoryProgressBarPercent" class="mr-6">
                                <h2>Memória</h2>
                            </div>
                        </div>
                        <div class="flex justify-center text-center">
                            <div id="memoryProgressBarMB" class="mr-6">
                                <h2>Memória</h2>
                            </div>
                        </div>
                        <div class="flex justify-center text-center">
                            <div id="cpuProgressBarPercent">
                                <h2>Processzor</h2>
                            </div>
                        </div>
                        <div class="flex justify-center text-center">
                            <div id="diskProgressBars">
                                <h2>Merevlemez</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="w-[95%] h-auto mt-6 ml-6 bg-[#ffffff] text-black flex flex-wrap justify-center shadow1 rounded-3xl">
                <div class="w-full h-auto flex justify-center mt-3 text-xl font-semibold">
                    <div class="w-full">
                        <h2>Statisztikák</h2>
                        <div class="w-full flex justify-center text-center">
                            {% include 'charts.html' %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script src="https://cdn.jsdelivr.net/npm/progressbar.js"></script>
    <script>

        let ram_all = 0;
        let ram_used = 0;

        const socket = new WebSocket('ws://127.0.0.1:8000/ws/hardware/');

        let diskBars = [];

        var memoryBarPercent = new ProgressBar.SemiCircle('#memoryProgressBarPercent', {
            strokeWidth: 8,
            color: 'black',
            trailColor: '#f5f7f9',
            trailWidth: 12,
            easing: 'easeInOut',
            duration: 1200,
            svgStyle: { width: '100%', height: '100%' },
            text: {
                value: '0%',
                alignToBottom: false
            },
            from: { color: '#3253d6' },
            to: { color: '#d632a5' },
            step: (state, bar) => {
                bar.path.setAttribute('stroke', state.color);
                var value = Math.round(bar.value() * 100);
                bar.setText(value + ' %'); // Megjelenítés
            }
        });


        var cpuBarPercent = new ProgressBar.SemiCircle('#cpuProgressBarPercent', {
            strokeWidth: 8,
            color: 'black',
            trailColor: '#f5f7f9',
            trailWidth: 12,
            easing: 'easeInOut',
            duration: 1200,
            svgStyle: { width: '100%', height: '100%' },
            text: {
                value: '0%',
                alignToBottom: false
            },
            from: { color: '#3253d6' },
            to: { color: '#d632a5' },
            step: (state, bar) => {
                bar.path.setAttribute('stroke', state.color);
                var value = Math.round(bar.value() * 100);
                bar.setText('~' + value + ' %'); // Megjelenítés
            }
        });

        // WebSocket kapcsolat létrejötte
        socket.onopen = function (event) {
            console.log("WebSocket kapcsolat létrejött");
        }

        // WebSocketen keresztül érkező adatok kezelése
        socket.onmessage = function (event) {

            const data = JSON.parse(event.data);

            if (typeof data.disk_usages === "string") {
                // Ha JSON string, alakítsd vissza objektummá
                data.disk_usages = JSON.parse(data.disk_usages);
            }

            // Statikus adatok frissítése
            if (data.cpu_type !== undefined) {
                document.getElementById('cpu_type').innerText = data.cpu_type;
                document.getElementById('core_count').innerText = data.core_count;
                ram_all = data.ram_all * 1024;
                document.getElementById('ram_all').innerText = ram_all / 1024 + "GB";
            }

            // Dinamikus adatok folyamatos frissítése
            if (data.cpu_freq_current !== undefined) {
                cpu_freq_current = data.cpu_freq_current;
                cpu_percent = data.cpu_percent;
                ram_used = data.ram_used;
                const ram_used_percent = data.ram_used_percent / 100; // Megjegyzés: ez az újított adatok közé került

                // RAM progress bar animálása
                memoryBarMB.animate(ram_used / ram_all, {
                    duration: 800,
                    easing: 'easeInOut'
                });
                memoryBarMB.setText(ram_used + ' MB');

                const memoryUsedPercent = data.ram_used_percent / 100;
                memoryBarPercent.animate(memoryUsedPercent,);

                const cpuUsedPercent = data.cpu_percent / 100;
                cpuBarPercent.animate(cpuUsedPercent);


                //Innen
                if (data.disk_usages) {
                    let disk_usage = data.disk_usages;

                    const updateDiskUsage = (index, usedMB, totalMB) => {
                        diskBars[`diskProgressBar${index}`].animate(usedMB / totalMB, {
                            duration: 800,
                            easing: 'easeInOut',
                            //Az animáció lefutása után lehet kérni a szöveg frissítését
                            step: (state, bar) => {
                                bar.setText(usedMB + "MB");
                                //console.log(index+ ": ")
                                //console.log(state)
                            }
                        }, //(console.log("lefut"))
                        )

                    }

                    disk_usage.forEach((disk, index) => {
                        let usedMB = disk.used;
                        let totalMB = disk.total;
                        let percentage = usedMB / totalMB;

                        // Ha a disk progress bar már létezik, frissítjük
                        if (diskBars[`diskProgressBar${index}`]) {
                            updateDiskUsage(index, usedMB, totalMB)

                        } else {
                            //Ha még nem létezik
                            console.log(`Creating progress bar for disk ${index} with total ${totalMB} MB`);

                            let progressBarContainer = document.createElement('div');
                            progressBarContainer.id = `diskProgressBar${index}`;
                            progressBarContainer.style.width = '300px';
                            progressBarContainer.style.marginBottom = '20px';
                            document.getElementById('diskProgressBars').appendChild(progressBarContainer);

                            //Progressbar 
                            diskBars[`diskProgressBar${index}`] = new ProgressBar.SemiCircle(`#diskProgressBar${index}`, {
                                strokeWidth: 8,
                                color: 'black',
                                trailColor: '#f5f7f9',
                                trailWidth: 12,
                                easing: 'easeInOut',
                                duration: 1200,
                                svgStyle: { width: '100%', height: '100%' },
                                text: {
                                    value: 0,
                                    alignToBottom: false
                                },
                                from: { color: '#3253d6' },
                                to: { color: '#d632a5' },
                            });

                            //Kezdeti animáció
                            diskBars[`diskProgressBar${index}`].animate(percentage, {
                                duration: 800,
                                easing: 'easeInOut',
                                step: (state, bar) => {
                                    bar.path.setAttribute('stroke', state.color);
                                    bar.setText(usedMB + "MB");
                                    //console.log(usedMB);
                                }
                            });
                        }
                    });
                }
                //Idáig
            }
        };

        // WebSocket kapcsolat lezárása
        socket.onclose = function (event) {
            console.log('WebSocket kapcsolat lezárult');
        };

        var memoryBarMB = new ProgressBar.SemiCircle('#memoryProgressBarMB', {
            strokeWidth: 8,
            color: 'black',
            trailColor: '#f5f7f9',
            trailWidth: 12,
            easing: 'easeInOut',
            duration: 1200,
            svgStyle: { width: '100%', height: '100%' },
            text: {
                value: '0 MB',
                alignToBottom: false
            },
            from: { color: '#3253d6' },
            to: { color: '#d632a5' },
            step: (state, bar) => {
                bar.path.setAttribute('stroke', state.color);
                bar.setText(ram_used + ' MB');
            }
        });
    </script>
</body>

</html>